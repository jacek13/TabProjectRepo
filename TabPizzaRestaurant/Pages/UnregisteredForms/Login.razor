@layout LoginLayout
@page "/login"

@using Models
@using TabPizzaRestaurant.Data

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject Repository.Services.AccountService accountService
@inject Repository.Services.ClientService clientService

<center>
    <h3 class="display-4">Login</h3>

    <EditForm Model="@user" OnValidSubmit="@ValidateUser">
        <div>Email or login:   <InputText id="email" @bind-Value="user.Email"/></div>
        <div>Password:   <InputText id="password" @bind-Value="user.Password"/></div>
        <button type="submit" class="btn btn-primary">Login</button>
    </EditForm>
    <br />
    <a class="custom-class text-center col-6 col-md-1 themed-grid-col" href="/register">Register</a>
</center>


@if(isException)
{
    <center> 
        <hr>
        <h3 style="color:rgb(255,51,51)">Błędne dane!</h3> 
    </center>
    <p>@error</p>
}
@code 
{
    private User user;
    private ClientFront Client;
    private string error;
    private bool isException = false;

    protected override Task OnInitializedAsync()
    {
        user = new User();
        Client = new ClientFront();
        return base.OnInitializedAsync();
    }

    private async Task<bool> ValidateUser()
    {
        try
        {
            var dbUser = await accountService.GetAccountByLoginAndPassword(user.Email, user.Password);
            var clientData = await clientService.GetClientByAccountId(dbUser.IdAccount);
            Client.Name = dbUser.Name;
            Client.Password = dbUser.Password;
            Client.Surname = dbUser.Surname;
            Client.Login = dbUser.Login;
            Client.Role = dbUser.Role;
            Client.EMail = dbUser.EMail;
            Client.PhoneNumber = dbUser.PhoneNumber;
            Client.Address = clientData.Address;

            // Client Front nie ma atrybutu points!
            isException = false;

            ((CustomAuthenticationStateProvider)AuthenticationStateProvider).MarkUserAsAuthenticated(Client);
            NavigationManager.NavigateTo("/");

            //TODO po logowaniu powinno nastąpić połączenie z bazą danych (i na podstawie tych danych wypełnić poniższe)
            await sessionStorage.SetItemAsStringAsync("email", Client.EMail);
            await sessionStorage.SetItemAsStringAsync("name", Client.Name);
            await sessionStorage.SetItemAsStringAsync("surname", Client.Surname);
            await sessionStorage.SetItemAsStringAsync("login", Client.Login);
            await sessionStorage.SetItemAsStringAsync("password", Client.Password);
            await sessionStorage.SetItemAsStringAsync("phone", Client.PhoneNumber);
            await sessionStorage.SetItemAsStringAsync("address", Client.Address);
            await sessionStorage.SetItemAsStringAsync("role", Client.Role);
            await sessionStorage.SetItemAsStringAsync("points", clientData.Points.ToString());

            return await Task.FromResult(true);
        }
        catch (Exception e)
        {
            error = e.ToString();
            isException = true;
            return await Task.FromResult(false);
        }
    }
}
